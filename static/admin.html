<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>tinyLollMS Admin Panel</title>
    <link rel="stylesheet" href="/static/design-tokens.css">
    <style>
        body { padding: 20px; background: var(--color-bg); }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .full { grid-column: span 2; }
        input, select { padding: 12px; border: 1px solid var(--color-muted); border-radius: 6px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .badge { font-family: monospace; background: #f0f0f0; padding: 3px 6px; border-radius: 4px; font-size: 12px; }
        .actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--color-primary); color: white; }
        .btn-danger { background: var(--color-error); color: white; }
    </style>
</head>
<body>
<div class="container">
    <div id="loginView">
        <h2>Admin Login</h2>
        <div class="grid-form" style="max-width: 400px;">
            <input type="text" id="user" placeholder="Username" value="admin">
            <input type="password" id="pass" placeholder="Password" value="admin123">
            <button onclick="login()" class="btn btn-primary full">Login</button>
        </div>
    </div>

    <div id="mainView" style="display:none">
        <div style="display:flex; justify-content: space-between;">
            <h1>Applications</h1>
            <button onclick="logout()" class="btn btn-danger">Logout</button>
        </div>

        <form id="appForm" class="grid-form">
            <input type="text" name="name" placeholder="Application Name" required>
            <select name="binding" required>
                <option value="lollms">Lollms</option>
                <option value="openai">OpenAI</option>
                <option value="open_router">OpenRouter</option>
                <option value="claude">Claude</option>
                <option value="google">Google Gemini</option>
                <option value="ollama">Ollama</option>
                <option value="vllm">vLLM</option>
                <option value="litellm">LiteLLM</option>
                <option value="llama_cpp_server">Llama.cpp</option>
                <option value="openwebui">OpenWebUI</option>
            </select>
            <input type="text" name="host_address" placeholder="Host URL (e.g. http://localhost:11434)">
            <input type="password" name="service_key" placeholder="API Key / Service Key">
            <input type="text" name="models" placeholder="Allowed Models (comma separated, empty = all)" class="full">
            <button type="submit" id="saveBtn" class="btn btn-primary full">Create Application</button>
        </form>

        <table id="appTable">
            <thead>
                <tr><th>Name</th><th>Binding</th><th>App Key</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let token = null;
    let editingKey = null;

    async function login() {
        const r = await fetch('/admin/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: user.value, password: pass.value})
        });
        if (r.ok) {
            token = (await r.json()).access_token;
            loginView.style.display = 'none';
            mainView.style.display = 'block';
            loadApps();
        } else alert("Invalid Credentials");
    }

    function logout() { token = null; loginView.style.display='block'; mainView.style.display='none'; }

    async function loadApps() {
        const r = await fetch('/admin/apps', {headers: {'Authorization': `Bearer ${token}`}});
        const apps = await r.json();
        const tbody = document.querySelector('#appTable tbody');
        tbody.innerHTML = apps.map(app => `
            <tr>
                <td>${app.name}</td>
                <td><b>${app.binding}</b></td>
                <td><span class="badge">${app.key}</span></td>
                <td class="actions">
                    <button onclick='editApp(${JSON.stringify(app)})'>Edit</button>
                    <button onclick="deleteApp('${app.key}')" style="color:red">Delete</button>
                </td>
            </tr>
        `).join('');
    }

    document.getElementById('appForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        const url = editingKey ? `/admin/apps/${editingKey}` : '/admin/add_app';
        await fetch(url, {
            method: editingKey ? 'PUT' : 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`},
            body: JSON.stringify(data)
        });
        editingKey = null;
        e.target.reset();
        saveBtn.textContent = "Create Application";
        loadApps();
    };

    function editApp(app) {
        editingKey = app.key;
        const f = document.getElementById('appForm');
        f.name.value = app.name;
        f.binding.value = app.binding;
        f.host_address.value = app.host_address || "";
        f.service_key.value = app.service_key || "";
        f.models.value = app.allowed_models.join(', ');
        saveBtn.textContent = "Update Application";
    }

    async function deleteApp(key) {
        if (confirm("Delete this application?")) {
            await fetch(`/admin/apps/${key}`, {method: 'DELETE', headers: {'Authorization': `Bearer ${token}`}});
            loadApps();
        }
    }
</script>
</body>
</html>
